{% extends 'emotion_app/base.html' %}

{% block title %}è¯†åˆ«è®°å½•{% endblock %}

{% block content %}
<!-- æ·»åŠ Chart.jsåº“ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2>ğŸ“Š å†å²è¯†åˆ«è®°å½•</h2>
        <span style="background: var(--bg-color); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; color: var(--text-secondary);">å…± {{ records_count }} æ¡</span>
    </div>
    
    <!-- æƒ…ç»ªå¯è§†åŒ–å›¾è¡¨åŒºåŸŸ -->
    {% if records_count > 0 %}
    <div style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1rem; color: var(--text-primary);">æƒ…ç»ªå˜åŒ–æ›²çº¿</h3>
        <div style="background: var(--bg-color); padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <canvas id="emotionTrendChart" width="800" height="300"></canvas>
        </div>
    </div>
    {% endif %}

    {% if records %}
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                <thead>
                    <tr style="background-color: #F9FAFB; text-align: left;">
                        <th style="padding: 1rem; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid #E5E7EB;">#</th>
                        <th style="padding: 1rem; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid #E5E7EB;">æ—¶é—´</th>
                        <th style="padding: 1rem; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid #E5E7EB;">å›¾ç‰‡åç§°</th>
                        <th style="padding: 1rem; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid #E5E7EB;">è¯†åˆ«ç»“æœ</th>
                        <th style="padding: 1rem; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid #E5E7EB;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in records %}
                        <tr style="border-bottom: 1px solid #F3F4F6; transition: background 0.2s;" onmouseover="this.style.backgroundColor='#F9FAFB'" onmouseout="this.style.backgroundColor='transparent'">
                        <td style="padding: 1rem; color: var(--text-secondary);">{{ forloop.counter }}</td>
                        <td style="padding: 1rem;">{{ record.created_at|date:"Y-m-d H:i" }}</td>
                        <td style="padding: 1rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ record.image_name }}">{{ record.image_name }}</td>
                        <td style="padding: 1rem;">
                            <span style="background: #ECFDF5; color: #065F46; padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.85rem; font-weight: 500;">
                                {{ record.emotion }}
                            </span>
                        </td>
                        <td style="padding: 1rem;">
                            <form method="POST" action="{% url 'delete_record' record.id %}" style="display: inline; margin: 0;">
                                {% csrf_token %}
                                <button type="submit" 
                                        style="background: #FFF1F0; color: #FF4D4F; border: 1px solid #FFCCC7; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s;"
                                        onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ');">
                                    åˆ é™¤
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div style="text-align: center; padding: 3rem 0; color: var(--text-secondary);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“­</div>
            <p>æš‚æ— è¯†åˆ«è®°å½•ï¼Œå¿«å»ä¸Šä¼ ä¸€å¼ å›¾ç‰‡è¯•è¯•å§ï¼</p>
        </div>
    {% endif %}

    <!-- ä¸€é”®æ“ä½œæŒ‰é’® -->
    {% if records_count > 0 %}
        <div style="margin: 2rem 0; text-align: center;">
            <button id="delete-all-btn" 
                    style="background: #FFF1F0; color: #FF4D4F; border: 1px solid #FFCCC7; 
                           padding: 0.75rem 1.5rem; border-radius: 8px; 
                           font-size: 1rem; font-weight: 500; cursor: pointer; 
                           transition: all 0.2s; margin-right: 1rem;">
                ä¸€é”®åˆ é™¤æ‰€æœ‰è®°å½•
            </button>
        </div>
    {% endif %}
    
    <div style="margin-top: 2rem; text-align: center;">
        <a href="{% url 'index' %}" class="btn">æ–°å»ºè¯†åˆ«</a>
    </div>
</div>

<!-- å›æ”¶ç«™æ¨¡æ€æ¡† -->
<div id="recycleModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: var(--bg-color); margin: 5% auto; padding: 2rem; border-radius: 12px; width: 80%; max-width: 800px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3>ğŸ—‘ï¸ å›æ”¶ç«™</h3>
            <button type="button" onclick="closeRecycleModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">Ã—</button>
        </div>
        
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">æ˜¾ç¤ºæœ€è¿‘{{ recycle_days }}å¤©å†…åˆ é™¤çš„è¯†åˆ«è®°å½•ï¼Œè¶…è¿‡{{ recycle_days }}å¤©å°†è‡ªåŠ¨æ¸…ç†ã€‚</p>
        
        {% if recycled_count > 0 %}
            <div style="overflow-x: auto; margin-bottom: 1rem;">
                <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
                    <thead>
                        <tr style="background-color: #F9FAFB; text-align: left;">
                            <th style="padding: 1rem; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid #E5E7EB;">#</th>
                            <th style="padding: 1rem; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid #E5E7EB;">æ—¶é—´</th>
                            <th style="padding: 1rem; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid #E5E7EB;">å›¾ç‰‡åç§°</th>
                            <th style="padding: 1rem; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid #E5E7EB;">è¯†åˆ«ç»“æœ</th>
                            <th style="padding: 1rem; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid #E5E7EB;">åˆ é™¤æ—¶é—´</th>
                            <th style="padding: 1rem; color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid #E5E7EB;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in recycled_records %}
                            <tr style="border-bottom: 1px solid #F3F4F6; opacity: 0.7;">
                                <td style="padding: 1rem; color: var(--text-secondary);">{{ forloop.counter }}</td>
                                <td style="padding: 1rem;">{{ record.created_at|date:"Y-m-d H:i" }}</td>
                                <td style="padding: 1rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ record.image_name }}">{{ record.image_name }}</td>
                                <td style="padding: 1rem;">
                                    <span style="background: #ECFDF5; color: #065F46; padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.85rem; font-weight: 500;">
                                        {{ record.emotion }}
                                    </span>
                                </td>
                                <td style="padding: 1rem; color: var(--text-secondary); font-size: 0.9rem;">{{ record.deleted_at|date:"Y-m-d H:i" }}</td>
                                <td style="padding: 1rem; display: flex; gap: 0.5rem;">
                                    <!-- æ¢å¤æŒ‰é’® -->
                                    <form method="POST" action="{% url 'restore_record' record.id %}" style="display: inline; margin: 0;">
                                        {% csrf_token %}
                                        <button type="submit" 
                                                style="background: #F6FFED; color: #52C41A; border: 1px solid #B7EB8F; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s;"
                                                onclick="return confirm('ç¡®å®šè¦æ¢å¤è¿™æ¡è®°å½•å—ï¼Ÿ');">
                                            æ¢å¤
                                        </button>
                                    </form>
                                    <!-- å½»åº•åˆ é™¤æŒ‰é’® -->
                                    <form method="POST" action="{% url 'permanent_delete_record' record.id %}" style="display: inline; margin: 0;">
                                        {% csrf_token %}
                                        <button type="submit" 
                                                style="background: #FFF1F0; color: #FF4D4F; border: 1px solid #FFCCC7; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s;"
                                                onclick="return confirm('ç¡®å®šè¦å½»åº•åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚');">
                                            å½»åº•åˆ é™¤
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- å›æ”¶ç«™ä¸€é”®æ“ä½œæŒ‰é’® - æ”¾åœ¨æ¨¡æ€æ¡†åº•éƒ¨ -->
            <div style="margin: 2rem 0; text-align: center;">
                <button id="restore-all-btn" 
                        style="background: #F6FFED; color: #52C41A; border: 1px solid #B7EB8F; 
                               padding: 0.75rem 1.5rem; border-radius: 8px; 
                               font-size: 1rem; font-weight: 500; cursor: pointer; 
                               transition: all 0.2s; margin-right: 1rem;">
                    ä¸€é”®æ¢å¤æ‰€æœ‰è®°å½•
                </button>
                <button id="permanent-delete-all-btn" 
                        style="background: #FFF1F0; color: #FF4D4F; border: 1px solid #FFCCC7; 
                               padding: 0.75rem 1.5rem; border-radius: 8px; 
                               font-size: 1rem; font-weight: 500; cursor: pointer; 
                               transition: all 0.2s;">
                    ä¸€é”®å½»åº•åˆ é™¤æ‰€æœ‰è®°å½•
                </button>
            </div>
        {% else %}
            <div style="text-align: center; padding: 3rem 0; color: var(--text-secondary);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ—‘ï¸</div>
                <p>å›æ”¶ç«™ä¸ºç©º</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- å›æ”¶ç«™æŒ‰é’® -->
<div style="position: fixed; bottom: 2rem; right: 2rem; z-index: 999;">
    <button onclick="openRecycleModal()" 
            style="background: #FFF1F0; color: #FF4D4F; border: 2px solid #FFCCC7; padding: 1rem 1.5rem; border-radius: 50%; font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 12px rgba(255, 77, 79, 0.2); transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.5rem;"
            title="æŸ¥çœ‹å›æ”¶ç«™">
        ğŸ—‘ï¸
        {% if recycled_count > 0 %}
            <span style="background: #FF4D4F; color: white; font-size: 0.8rem; font-weight: bold; border-radius: 12px; min-width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">{{ recycled_count }}</span>
        {% endif %}
    </button>
</div>

<script>
    // æ‰“å¼€å›æ”¶ç«™æ¨¡æ€æ¡†
    function openRecycleModal() {
        document.getElementById('recycleModal').style.display = 'block';
    }
    
    // å…³é—­å›æ”¶ç«™æ¨¡æ€æ¡†
    function closeRecycleModal() {
        document.getElementById('recycleModal').style.display = 'none';
    }
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
        const modal = document.getElementById('recycleModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
    
    // ä¸€é”®åˆ é™¤æ‰€æœ‰è®°å½•
    document.getElementById('delete-all-btn')?.addEventListener('click', function() {
        if (confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œå¯ä»¥åœ¨å›æ”¶ç«™ä¸­æ¢å¤ã€‚')) {
            // åˆ›å»ºè¡¨å•å¹¶æäº¤
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url 'delete_all_records' %}';
            form.innerHTML = '<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">';
            document.body.appendChild(form);
            form.submit();
        }
    });
    
    // ä¸€é”®æ¢å¤æ‰€æœ‰è®°å½•
    document.getElementById('restore-all-btn')?.addEventListener('click', function() {
        if (confirm('ç¡®å®šè¦æ¢å¤æ‰€æœ‰è®°å½•å—ï¼Ÿ')) {
            // åˆ›å»ºè¡¨å•å¹¶æäº¤
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url 'restore_all_records' %}';
            form.innerHTML = '<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">';
            document.body.appendChild(form);
            form.submit();
        }
    });
    
    // ä¸€é”®å½»åº•åˆ é™¤æ‰€æœ‰è®°å½•
    document.getElementById('permanent-delete-all-btn')?.addEventListener('click', function() {
        if (confirm('ç¡®å®šè¦å½»åº•åˆ é™¤æ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
            // åˆ›å»ºè¡¨å•å¹¶æäº¤
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url 'permanent_delete_all_records' %}';
            form.innerHTML = '<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">';
            document.body.appendChild(form);
            form.submit();
        }
    });
</script>

{% if records_count > 0 %}
<!-- ç¯å½¢æŠ˜çº¿å›¾ï¼šæƒ…ç»ªå‡ºç°æ¬¡æ•°åˆ†æ -->
<script>
    // æƒ…ç»ªé¢œè‰²
    const emotionColorMap = {
        'æ„¤æ€’': '#FF4D4F',
        'åŒæ¶': '#9254DE',
        'ææƒ§': '#F5222D',
        'æ‚²ä¼¤': '#1890FF',
        'ä¸­ç«‹': '#8C8C8C',
        'æƒŠè®¶': '#FAAD14',
        'å¼€å¿ƒ': '#52C41A'
    };
    
    // æƒ…ç»ªç±»å‹åˆ—è¡¨
    const emotionTypes = ['æ„¤æ€’', 'åŒæ¶', 'ææƒ§', 'æ‚²ä¼¤', 'ä¸­ç«‹', 'æƒŠè®¶', 'å¼€å¿ƒ'];
    
    // å‡†å¤‡æ•°æ®
    const timelineData = [
        {% for item in emotion_timeline %}
        {
            time: '{{ item.time }}',
            emotion: '{{ item.emotion }}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // ç»Ÿè®¡æ¯ç§æƒ…ç»ªçš„å‡ºç°æ¬¡æ•°
    const emotionStats = {
        'æ„¤æ€’': { count: 0 },
        'åŒæ¶': { count: 0 },
        'ææƒ§': { count: 0 },
        'æ‚²ä¼¤': { count: 0 },
        'ä¸­ç«‹': { count: 0 },
        'æƒŠè®¶': { count: 0 },
        'å¼€å¿ƒ': { count: 0 }
    };
    
    // è®¡ç®—æ¯ç§æƒ…ç»ªçš„å‡ºç°æ¬¡æ•°
    timelineData.forEach(item => {
        if (emotionStats[item.emotion]) {
            emotionStats[item.emotion].count++;
        }
    });
    
    // å‡†å¤‡ç¯å½¢æŠ˜çº¿å›¾æ•°æ®
    const chartData = emotionTypes.map(emotion => {
        return {
            emotion: emotion,
            value: emotionStats[emotion].count,
            color: emotionColorMap[emotion]
        };
    });
    
    // æå–æ•°æ®å€¼
    const dataValues = chartData.map(item => item.value);
    const dataLabels = chartData.map(item => item.emotion);
    const dataColors = chartData.map(item => item.color);
    
    // è®¡ç®—åŠ¨æ€æœ€å¤§å€¼ï¼šå–å®é™…æ•°æ®çš„æœ€å¤§å€¼ï¼Œå‘ä¸Šå–æ•´åˆ°æœ€è¿‘çš„5ï¼Œç¡®ä¿å›¾è¡¨æœ‰é€‚å½“çš„ç•™ç™½
    const maxValue = Math.max(...dataValues);
    const dynamicMax = maxValue > 0 ? Math.ceil(maxValue / 5) * 5 : 10;
    
    // åˆ›å»ºç¯å½¢æŠ˜çº¿å›¾
    const ctx = document.getElementById('emotionTrendChart').getContext('2d');
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: dataLabels,
            datasets: [{
                label: 'æƒ…ç»ªå‡ºç°æ¬¡æ•°',
                data: dataValues,
                borderColor: '#1890FF',
                backgroundColor: 'rgba(24, 144, 255, 0.2)',
                borderWidth: 3,
                pointBackgroundColor: dataColors,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 8,
                pointHoverRadius: 10,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            height: 400,
            plugins: {
                title: {
                    display: true,
                    text: 'æƒ…ç»ªç»¼åˆåˆ†æ',
                    font: {
                        size: 20,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: true,
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const emotion = dataLabels[context.dataIndex];
                            const count = context.parsed.r;
                            return `${emotion}: å‡ºç°${count}æ¬¡`;
                        }
                    }
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: dynamicMax,
                    min: 0,
                    ticks: {
                        // åŠ¨æ€è°ƒæ•´åˆ»åº¦é—´éš”ï¼Œç¡®ä¿æœ‰5-6ä¸ªåˆ»åº¦
                        stepSize: Math.ceil(dynamicMax / 5),
                        callback: function(value) {
                            return value;
                        }
                    },
                    grid: {
                        circular: true,
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    angleLines: {
                        color: 'rgba(0, 0, 0, 0.2)'
                    },
                    pointLabels: {
                        font: {
                            size: 12,
                            weight: '500'
                        },
                        color: '#333'
                    }
                }
            },
            elements: {
                line: {
                    borderJoinStyle: 'round'
                }
            }
        }
    });
</script>
{% endif %}
{% endblock %}